#!/bin/bash
#
# a ufw script to prevent leaks when connected to a VPN
# taken from https://gitlab.jaytaala.com/j.taala/killswitch/-/blob/master/vpnkillswitch
#
# to stow:
# <exec-shell-cmd "stow vpnkillswitch">
#
# for ~/.local/bin
# <exec-shell-cmd "chmod +x ./vks">

while getopts ":edt:" opt; do
	case ${opt} in
		e)
			# ENABLE KILLSWITCH
			# Default policies
			sudo ufw default deny incoming
			sudo ufw default deny outgoing

			# Openvpn interface (adjust interface accordingly to your configuration)
			sudo ufw allow out on tun0

			# Openvpn (adjust port accordingly to your vpn setup)
			sudo ufw allow out to any port 1194
			;;
		d)
			# DISABLE KILLSWITCH
			sudo ufw --force reset
			sudo ufw enable

			# delete backUP rules from reset
			sudo rm /etc/ufw/*.rules.*

			# reset to defaults and enable
			sudo ufw default deny incoming
			sudo ufw default allow outgoing
			;;
		t)
			# ADD OUTGOING RULE
			echo "allow outgoing traffic to $OPTARG"
			sudo ufw allow out to $OPTARG
			;;
	esac
done

if (( $OPTIND == 1 )); then
	echo " "
	echo -e "Please provide at least one of the following options:\n    -e"
	echo "        enable killswitch"
	echo "    -d"
	echo "        disable killswitch"
	echo "    -t [CIDR]"
	echo -e "        open outgoing ufw rule to a specific CIDR (ip address or range)\n"
fi
