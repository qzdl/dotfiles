:PROPERTIES:
:ID:       53b915d9-5347-4878-832c-713a45b5be75
:END:
#+auto_tangle: yes
#+PROPERTY: header-args       :tangle-mode (identity #o444)
#+PROPERTY: header-args:shell :tangle-mode (identity #o755)
#+title: system configuration

[[id:2e1b78ef-de6f-4af9-8a89-5d5ffe12a3ba][My]] system configurations for [[id:959414da-620e-473b-80fc-1918fb459c02][GNU Guix]], compiled by [[id:953e0494-76b3-4ab7-bfe6-944e178b59dd][GNU Emacs]], deployed by [[id:884406e4-0851-4dc3-a6d3-cfe1c9fa1b2b][GNU
Stow]].

involves some [[id:f43fa203-367c-44a9-9762-e623f4ae41d1][system administration]], [[id:5f896cd4-d7b8-44d2-a40d-ccdae1b80c33][programming]], and rice.

inspired by [[https://config.daviwil.com/systems][System Configuration with Guix - config.daviwil.com]]

* configuration
** testing
#+begin_src bash
bash ~/dotfiles/update-dotfiles.sh
#+end_src

*** helpers
#+begin_src bash :tangle .local/bin/test-helpers.sh
headline() {
  echo "============================"
  echo $@
  echo "============================"
}

block() {
    echo "===$@"
}

delim() { echo && echo; }
#+end_src
*** test-system
#+begin_src shell :tangle .local/bin/test-system.sh
source test-helpers.sh
source $HOME/.config/shell/profile

MY_BASEPATH=$HOME/dotfiles
GUIX_LOADPATH_MY="$MY_BASEPATH/guix"
GUIX_LOADPATH_QZDL="$GUIX_LOADPATH_MY/qzdl"

cd $MY_BASEPATH

while getopts ":h" option; do
    case $option in
        h)
            help
            exit;;
        l)
            LINT=1 run_test
            exit;;
        \?) # unknown opt
            echo "ERROR: unknown option"
            exit 1;;
    esac
done
help() {
    echo "Test guix config"
    echo
    echo "usage: 'bash test-system.sh'"
    echo "options: -[h|l]"
    echo "h     print this help"
    echo "l     lint $GUIX_LOADPATH_QZDL"

}

test-load-file() {
    FILE=$1
    (
      echo "...TESTING $FILE"
      echo ".....LOADING 'GUIX REPL -L $GUIX_LOADPATH_MY $FILE'"
      guix repl -L $GUIX_LOADPATH_MY $FILE \
          && qz-color $qz_greener ".....PASSED: $FILE"
    )
}

run_test() {
  headline "TESTING SYSTEM CONFIGURATION"

  block "BEGIN: GUIX SYSTEM DESCRIBE"
  guix system describe
  block "END: GUIX SYSTEM DESCRIBE"
  delim

  if [ $LINT ]; then
    block "BEGIN: GUIX LINT"
    echo "...LINTING $GUIX_LOADPATH_QZDL"
    guix lint -L $GUIX_LOADPATH_QZDL
    block "END: GUIX LINT"
    delim
  fi
}

run_test
#+end_src

#+RESULTS:

*** update-dotfiles
#+begin_src shell :tangle .local/bin/update-dotfiles.sh
source test-helpers.sh
cd $HOME/dotfiles

headline "UPDATING DOTFILES"
delim

block "BEGIN: COMPILE DOTFILES"
emacs -Q --batch --script $HOME/dotfiles/.doom.d/tangle-dotfiles.el
block "END: COMPILE DOTFILES"
delim

block "BEGIN: STOW DOTFILES"
stow .
block "END: STOW DOTFILES"
delim

block "BEGIN: UPDATE EMACS INSTANCE"
emacsclient \
    -e '(load-file "~/dotfiles/.doom.d/per-system-settings.el")' \
    -a "No emacs server running"
block "END: UPDATE EMACS INSTANCE"
delim

test-system.sh
#+end_src
*** compilation
**** .doom.d/tangle-dotfiles.el
#+begin_src emacs-lisp :tangle .doom.d/tangle-dotfiles.el
(require 'org)

(defun qz/tangle-sys ()
  (interactive)
;; Don't ask when evaluating code blocks
(setq-local org-confirm-babel-evaluate nil)

(let* ((dotfiles-path (expand-file-name "~/dotfiles/"))
       (org-files (directory-files dotfiles-path nil "\\.org$")))

  (defun dw/tangle-org-file (org-file)
    (message "\n\033[1;32m...Updating %s\033[0m\n" org-file)
    (org-babel-tangle-file (expand-file-name org-file dotfiles-path)))

  ;; Tangle Systems.org first
  (dw/tangle-org-file "systems.org")

  (dolist (org-file org-files)
    (unless (member org-file '("README.org" "systems.org"))
      (dw/tangle-org-file org-file)))))

(qz/tangle-sys)
#+end_src

*** debug
**** tree
#+begin_src shell :results drawer
tree $HOME/dotfiles/.config/guix
#+end_src

#+RESULTS:
:results:
/home/samuel//dotfiles/.config/guix
├── channels.scm
├── current -> /var/guix/profiles/per-user/samuel/current-guix
└── qzdl
    ├── device
    │   ├── donutrust.scm
    │   └── xps.scm
    ├── packages
    │   ├── go-mvdan-sh.scm
    │   └── python-3.6.4.scm
    ├── qzdl.scm
    ├── rules.scm
    ├── services.scm
    └── system
        ├── base.scm
        ├── install.scm
        └── minimal.scm

5 directories, 11 files
:end:

** =(qzdl)=
:PROPERTIES:
:header-args: :tangle .config/guix/qzdl/qzdl.scm
:END:
:: .config/guix/qzdl/qzdl.scm
**** define
#+begin_src scheme :tangle .config/guix/qzdl/qzdl.scm
(define-module (qzdl)
  #:export (my-name))

(define my-name "Samuel Culpepper")
#+end_src
**** test
#+begin_src shell :tangle test-system.sh
test-load-file $HOME/dotfiles/.config/guix/qzdl/qzdl.scm
#+end_src
** =(qzdl systems)=
*** explanation
with a simple separation of concerns, in attempts to eliminate redundancy:
- base; minimum common denominators    (vc, emacs, networking, vpn, ssh, ...)
- minimal; for a small board (pi, ...) (base, specific things, ...)
- clean; for regular use               (base, X11, web browser, ...)

created using modules, as described:
- [[https://www.gnu.org/software/guile/manual/html_node/Modules.html#Modules][Modules (Guile Reference Manual)]]
- [[https://guix.gnu.org/en/manual/en/html_node/Package-Modules.html#Package-Modules][Package Modules (GNU Guix Reference Manual)]]
- [[https://guix.gnu.org/en/manual/en/html_node/Defining-Packages.html#Defining-Packages][Defining Packages (GNU Guix Reference Manual)]]
- I am yet to understand how ~module~ relates to ~define[-public]~, and how ~packages~
  relate to ~modules~.
  - will #:use-module (gnu packages emacs) install a package ~emacs~? or make the build/sub available?
  - how can i build packages for an installation?
  - how does a manifest relate to [ module(gnu package emacs)-> packages(emacs-no-x-toolkite) || manifest emacs-no-x-toolkit@28.1 ] ?

*** =(qzdl system base)= :file:
:PROPERTIES:
:ID:       61f53bfc-e34f-42ac-9dea-6f5e57f9a056
:header-args: :tangle .config/guix/qzdl/system/base.scm
:ROAM_ALIASES: "guix base system"
:END:
::  .config/guix/qzdl/system/base.scm
***** define
#+begin_src scheme :tangle  .config/guix/qzdl/system/base.scm
(define-module (qzdl system base)
  #:use-module (gnu)
  #:use-module (srfi srfi-1) ; scheme extensions per https://srfi.schemers.org/srfi-159/srfi-159.html
  #:use-module (gnu system nss) ;; network security service; appdev ssl,tls, etc
  #:use-module (gnu services docker)
  #:use-module (gnu services networking)
  #:use-module (gnu packages vim)
  #:use-module (gnu packages emacs)
  #:use-module (gnu packages linux)
  #:use-module (gnu packages version-control)
  #:use-module (gnu packages package-management)
  #:use-module (nongnu packages linux)
  #:use-module (nongnu system linux-initrd)
  #:export (base-operating-system))
#+end_src

#+RESULTS:

***** test
#+begin_src shell :tangle .local/bin/test-system.sh
test-load-file .config/guix/qzdl/system/base.scm
#+end_src
***** package modules
#+begin_src scheme :tangle  .config/guix/qzdl/system/base.scm
(use-package-modules certs)
(use-package-modules shells)
#+end_src
***** base-operating-system
:: [[https://guix.gnu.org/en/manual/en/html_node/operating_002dsystem-Reference.html#operating_002dsystem-Reference][operating-system Reference (GNU Guix Reference Manual)]]
:: [[https://guix.gnu.org/en/manual/en/html_node/Using-the-Configuration-System.html][Using the Configuration System (GNU Guix Reference Manual)]]

timezone[fn:1], locale[fn:2], default hostname etc

initrd[fn:3] 'inital ram disk'; for the bootloader to invoke ram
:: [[https://guix.gnu.org/en/manual/en/html_node/Initial-RAM-Disk.html][Initial RAM Disk (GNU Guix Reference Manual)]]
- the kernel loads 'compiled-in' drivers
- temporary filesystem
- init script
  - to load 'additional modules' (for the kernel)
    - ~operating-system -> initrd-modules~ in guix

based on our initrd config, we can even 'boot-to-Guile' with the ~--repl~ flag, to land in a repl in the initial ram disk. wild. [fn:5]

we are instructing initrd to populate with proprietary microcode[fn:4] ("ucode")
for processors.

I'm not happy about this blob usage AT ALL, but it's the cost of using non-free
hardware. exercise limited trust in these machines.

if running on a removable drive, it may be worth adding both amd
and intel ucode images to the bootloader config in initrd.

:: [[https://guix.gnu.org/en/manual/en/html_node/Keyboard-Layout.html][Keyboard Layout (GNU Guix Reference Manual)]]
- 'model' comes from ~share/X11/xkb~ of package ~xkeyboard-config~
#+begin_src scheme :tangle  .config/guix/qzdl/system/base.scm
(define base-operating-system
  (operating-system
   (host-name "unconf")
   (timezone "Europe/Berlin")
   (locale "en_US.UTF-8")

   ;; nonfree kernel
   (kernel linux)
   (firmware (list linux-firmware))
   (initrd microcode-initrd)

   ;; disable ipv6 for safe vpn usage; we just aren't there yet :/
   (kernel-arguments '("quiet" "ipv6.disable=1" "net.ifnames=0"))

   ;; kernel layout, not necessarily X layout
   (keyboard-layout (keyboard-layout "us" "altgr-intl" #:model "thinkpad"))

   ;; UEFI+GRUB
   (bootloader (bootloader-configuration
                (bootloader grub-efi-bootloader)
                (target "/boot/efi")
                (keyboard-layout keyboard-layout)))

   ;; base user
   (users (cons (user-account
                 (name "samuel")
                 (comment "it me")
                 (group "users")
                 (home-directory "/home/samuel/")
                 (supplementary-groups '("wheel"     ;; sudo
                                         "netdev"    ;; network devices
                                         "kvm"       ;; virtualisation
                                         "tty"
                                         "input"
                                         "lp"        ;; control bluetooth devices
                                         "audio"     ;; control audio devices
                                         "video"     ;; control video devices
                                         "docker")))
                %base-user-accounts))

   ;; OVERWRITE THIS WHEN INHERITING
   ;;   AN ARTIFACT OF INCIDENTAL COMPLEXITY IN GUIX
   (file-systems (cons*
                  (file-system
                   (mount-point "/")
                   (device "none")
                   (type "tmpfs")
                   (check? #f))
                  %base-file-systems))

   (packages (append (list
                      git
                      stow
                      emacs
                      vim
                      ;;openvpn
                      nss-certs
                      ;; fs utils
                      ;;gvfs
                      ;;fuse-exfat
                      ;;exfat-utils
                      )
                     %base-packages))

   ;; Use the "desktop" services, which include the X11 log-in service,
   ;; networking with NetworkManager, and more
   (services (append (list (service docker-service-type)
                           (extra-special-file "/usr/bin/env"
                                               (file-append coreutils "/bin/env"))
                           ;(service thermald-service-type)
                           )
                     %base-services)))) ;; TODO INSPECT %base-services
#+end_src

*** =(qzdl system tiny)=  :file:
:PROPERTIES:
:ID:       2c540af7-a823-4ce8-b8ea-eee0372749bc
:header-args:  :tangle .config/guix/qzdl/system/tiny.scm
:ROAM_ALIASES: "guix tiny system"
:END:
:: .config/guix/qzdl/system/tiny.scm
consumes [[id:61f53bfc-e34f-42ac-9dea-6f5e57f9a056][guix base system]]
*** =(qzdl system minimal)= :file:
:PROPERTIES:
:ID:       1134d479-ddd6-4963-a001-aa84f471db49
:header-args: :tangle .config/guix/qzdl/system/minimal.scm
:ROAM_ALIASES: "guix minimal system"
:END:
:: .config/guix/qzdl/system/minimal.scm
things for 'full systems' -> consumes [[id:61f53bfc-e34f-42ac-9dea-6f5e57f9a056][guix base system]]

***** test
#+begin_src shell :tangle .local/bin/test-system.sh
test-load-file .config/guix/qzdl/system/minimal.scm
#+end_src
***** define
#+begin_src scheme :tangle .config/guix/qzdl/system/minimal.scm
(define-module (qzdl system minimal)
  #:use-module (qzdl system base)
  #:use-module (qzdl services)
  #:use-module (gnu)
  #:use-module (gnu system)
  #:use-module (srfi srfi-1)
  #:use-module (gnu services pm)             ;; clipboard menu
  #:use-module (gnu services cups)           ;; printing
  #:use-module (gnu services docker)
  #:use-module (gnu services databases)
  #:use-module (gnu services virtualization) ;; VMs
  #:use-module (gnu packages xorg)           ;; graphical display
  #:use-module (gnu packages gnuzilla)       ;; GNU mozilla suite
  #:use-module (gnu packages audio)          ;;
  #:use-module (gnu packages pulseaudio)     ;; audio daemon
  #:use-module (gnu packages wm)             ;; lots of wm options (blote)
  #:use-module (gnu packages cups)           ;; printing
  #:use-module (gnu packages mtools)         ;; interact with ms disks
  #:use-module (gnu packages gtk)            ;; gnome stuff  (blote)
  #:use-module (gnu packages web-browsers)  ;; web browsers (blote)
  #:export (minimal-operating-system))
#+end_src
***** services
#+begin_src scheme :tangle .config/guix/qzdl/system/minimal.scm
(use-service-modules desktop xorg)
#+end_src
***** operating-system
- [[https://guix.gnu.org/en/manual/en/html_node/Desktop-Services.html#index-_0025desktop_002dservices][Desktop Services (GNU Guix Reference Manual)]]
#+begin_src scheme :tangle .config/guix/qzdl/system/minimal.scm
(define minimal-operating-system
  (operating-system
   (inherit base-operating-system)

   (services (cons*
              my-libvirt-service
              my-bluetooth-service
              my-docker-service
              %my-desktop-services
              (operating-system-services base-operating-system)))

   (packages
    (cons* pulseaudio
           bluez
           bluez-alsa
           tlp                  ;; laptop power management
           fx86-input-libinput
           emacs
           (operating-system-packages base-operating-system)))))
#+end_src
*** =(qzdl system install)= :file:
:: https://gitlab.com/nonguix/nonguix/blob/master/nongnu/system/install.scm

#+begin_src scheme :tangle .config/guix/qzdl/system/install.scm
;;; Copyright © 2019 Alex Griffin <a@ajgrf.com>
;;; Copyright © 2019 Pierre Neidhardt <mail@ambrevar.xyz>
;;;
;;; This program is free software: you can redistribute it and/or modify

;;; it under the terms of the GNU General Public License as published by
;;; the Free Software Foundation, either version 3 of the License, or
;;; (at your option) any later version.
;;;
;;; This program is distributed in the hope that it will be useful,
;;; but WITHOUT ANY WARRANTY; without even the implied warranty of
;;; MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
;;; GNU General Public License for more details.
;;;
;;; You should have received a copy of the GNU General Public License
;;; along with this program.  If not, see <https://www.gnu.org/licenses/>.

;; Generate a bootable image (e.g. for USB sticks, etc.) with:
;; <exec-shell-cmd "guix system disk-image nongnu/system/install.scm">

(define-module (nongnu system install)
  #:use-module (gnu system)
  #:use-module (gnu system install)
  #:use-module (nongnu packages linux)
  #:use-module (gnu packages version-control)
  #:use-module (gnu packages vim)
  #:use-module (gnu packages curl)
  #:use-module (gnu packages emacs)
  #:use-module (gnu packages package-management)
  #:export (installation-os-nonfree))

(define installation-os-nonfree
  (operating-system
    (inherit installation-os)
    (kernel linux)
    (firmware (list linux-firmware))
    (kernel-arguments '("net.ifnames=0"))

    (packages (append (list git curl stow vim emacs-no-x-toolkit)
                      ;; (operating-system-packages base-operating-system)
                      (operating-system-packages installation-os)))))

installation-os-nonfree
#+end_src

** =(qzdl services)=
:PROPERTIES:
:header-args: :tangle .config/guix/qzdl/services.scm
:END:
:: .config/guix/qzdl/services.scm

**** define
#+begin_src scheme :tangle .config/guix/qzdl/services.scm
(define-module (qzdl services)
  #:use-module (gnu services)
  #:use-module (gnu services base)
  #:use-module (gnu services desktop)   ;; for udev
  #:use-module (gnu services databases) ;; for %desktop-services
  #:use-module (gnu services desktop)
  #:use-module (gnu services docker)
  #:use-module (gnu services networking)
  #:use-module (gnu services virtualization)
  #:use-module (srfi srfi-1)             ;; provides remove
  #:export (my-libvirt-service
            my-docker-service
            my-bluetooth-service
            ;;my-xorg-service
            ;;my-network-manager-service
            ;;my-ssh-service
            my-postgresql-service
            my-postgresql-role-service
            %my-desktop-services))
#+end_src
**** test
#+begin_src shell :tangle .local/bin/test-system.sh
test-load-file $HOME/dotfiles/.config/guix/qzdl/services.scm
#+end_src


**** TODO xorg-service
#+begin_src scheme .config/guix/qzdl/services.scm
 ;; X11
              ;; (service slim-service-type
              ;;    (slim-configuration
              ;;     (xorg-configuration
              ;;      (xorg-configuration
              ;;       (keyboard-layout
              ;;        (operating-system-keyboard-layout base-operating-system)
              ;;        (extra-config (list %xorg-libinput-config)))))))
#+end_src
**** TODO bluetooth-service
users must be in the =lp= group
#+begin_src scheme :tangle .config/guix/qzdl/services.scm
(define my-bluetooth-service
  (bluetooth-service #:auto-enable? #t))
#+end_src

**** TODO postgresql-service
:: https://guix.gnu.org/manual/en/html_node/Database-Services.html

#+begin_src scheme :tangle .config/guix/qzdl/services.scm
(define my-postgresql-role-service
  (service postgresql-role-service-type
   (postgresql-role-configuration
    (roles
     (list (postgresql-role
            (name "postgres")
            (create-database? #t))
           (postgresql-role
            (name "samuel")
            (create-database? #t)))))))

(define my-postgresql-service
  (service postgresql-service-type))
#+end_src
**** TODO network-manager-service w/ openvpn
**** TODO sshd service
#+begin_src scheme

#+end_src
**** TODO homelab services
**** TODO virtualisation; libvert
#+begin_src scheme :tangle .config/guix/qzdl/services.scm
(define my-libvirt-service
  (service libvirt-service-type
           (libvirt-configuration
            (unix-sock-group "libvirt")
            (tls-port "16555"))))
#+end_src
**** docker
requires user & group
#+begin_src scheme :tangle .config/guix/qzdl/services.scm
(define my-docker-service
  (service docker-service-type))
#+end_src
**** TODO desktop
should prolly split this out
#+begin_src scheme :tangle .config/guix/qzdl/services.scm
(define %my-desktop-services
  (remove
   (lambda (s) (or (eq? s gdm-service-type)
              (eq? s slim-service-type)))
    (modify-services
     %desktop-services
       (elogind-service-type config =>
                             (elogind-configuration (inherit config)
                                                    (handle-lid-switch-external-power 'suspend)))
       (udev-service-type config =>
                          (udev-configuration (inherit config)
                                              (rules (cons %udev-rule-backlight
                                                           (udev-configuration-rules config)))))
       (network-manager-service-type config =>
                                   (network-manager-configuration (inherit config)
                                                                  (vpn-plugins (list network-manager-openvpn)))))))
#+end_src
** =(qzdl rules)=
#+PROPERTY header-args:scheme :tangle .config/guix/qzdl/rules.scm
:: .config/guix/qzdl/rules.scm

**** define
#+begin_src scheme :tangle .config/guix/qzdl/rules.scm
(define-module (qzdl rules)
  #:use-module (gnu services desktop)
  #:use-module (gnu services base)
  #:export (%udev-rule-backlight
            %xorg-libinput-config))
#+end_src
**** test
#+begin_src shell :tangle .local/bin/test-system.sh
test-load-file .config/guix/qzdl/rules.scm
#+end_src
**** udev-rule-backlight
allow members of the "video" group to change the screen brightness.
#+begin_src scheme :tangle .config/guix/qzdl/rules.scm
(define %udev-rule-backlight
  (udev-rule
   "90-backlight.rules"
   (string-append "ACTION==\"add\", SUBSYSTEM==\"backlight\", "
                  "RUN+=\"/run/current-system/profile/bin/chgrp video /sys/class/backlight/%k/brightness\""
                  "\n"
                  "ACTION==\"add\", SUBSYSTEM==\"backlight\", "
                  "RUN+=\"/run/current-system/profile/bin/chmod g+w /sys/class/backlight/%k/brightness\"")))
#+end_src

#+RESULTS:
**** xorg-libinput
just a better laptop-trackpad control surface
#+begin_src scheme :tangle .config/guix/qzdl/rules.scm
(define %xorg-libinput-config
  "Section \"InputClass\"
  Identifier \"Touchpads\"
  Driver \"libinput\"
  MatchDevicePath \"/dev/input/event*\"
  MatchIsTouchpad \"on\"

  Option \"Tapping\" \"on\"
  Option \"TappingDrag\" \"on\"
  Option \"DisableWhileTyping\" \"on\"
  Option \"MiddleEmulation\" \"on\"
  Option \"ScrollMethod\" \"twofinger\"
  Option \"Natural Scrolling\" \"on\"
EndSection
Section \"InputClass\"
  Identifier \"Keyboards\"
  Driver \"libinput\"
  MatchDevicePath \"/dev/input/event*\"
  MatchIsKeyboard \"on\"
EndSection
")
#+end_src
**** TODO xorg screentearing-rule
** =(qzdl devices)=
*** =(qzdl devices xps)= :@home:
consuming [[id:1134d479-ddd6-4963-a001-aa84f471db49][guix minimal system]]
*** =(qzdl devices donutrust)= :@work:
#+PROPERTY: header-args:scheme :tangle .config/guix/qzdl/device/donutrust.scm
my thinkpad x1 carbon; a work machine. consumes [[id:1134d479-ddd6-4963-a001-aa84f471db49][guix minimal system]]

**** define
#+begin_src scheme
(define-module (qzdl system donutrust)
 #:use-module (minimal-system)
 #:use-module (gnu)
 #:use-module (nongnu packages linux))
#+end_src
**** test
#+begin_src shell :tangle .local/bin/test-system.sh
test-load-file .config/guix/qzdl/device/donutrust.scm
#+end_src
**** operating system
#+begin_src scheme
(operating-system
 (inherit minimal-operating-system)
 (host-name "donutrust")

 (firmware (list linux-firmware sof-firmware))

 (mapped-devices
  (list (mapped-device
         (source (uuid "c9042f21-04bd-48ff-9295-5e314f1d4b37"))
         (target "sys-root")
         (type luks-device-mapping))))

 (services
   (modify-services
    (operating-system-services minimal-operating-system)
    (postgresql-role-service-type
     config => (postgresql-role-configuration
                (inherit config)
                (extensions (list (service-extension postgresql-role-service-type
                    (const (postgresql-role
                            (name "newstore")
                            (create-database? #t))))))))))

 (file-systems (cons*
                (file-system
                 (device (file-system-label "sys-root"))
                 (mount-point "/")
                 (type "ext4")
                 (dependencies mapped-devices))
                (file-system
                 (device "/dev/nvme0n1p1")
                 (mount-point "/boot/efi")
                 (type "vfat"))
                %base-file-systems)))
#+end_src
*** =(qzdl devices cleanpi)= :@home:
#+begin_src scheme :tangle .config/guix/qzdl/device/xps.scm
(define-module (qzdl device xps))
#+end_src
** =(qzdl packages)=
:: .config/guix/qzdl/packages

*** v4l2loopback-linux-module
virtual video devices; hijack the webcam feed, or stream an application though loopback
*** mtools :core:
:: [[https://www.gnu.org/software/mtools/][Mtools - GNU Project - Free Software Foundation]]
*** dunst
:: https://dunst-project.org/
:: https://dunst-project.org/documentation

**** notify-emacs.sh
a script from u/deaddyfreddy, from
https://reddit.com/r/emacs/comments/klsxwv/enabling_desktop_notifications_with_dunst_emacs/ghb17s2

#+begin_src sh :tangle .config/dunst/notify-emacs.sh
#!/bin/sh

APPNAME="$1"
SUMMARY="$2"
BODY="$3"
ICON="$4"
URGENCY="$5"
emacsclient -n --eval "(message \"${APPNAME}/${SUMMARY}: $BODY\")"
#+end_src

*** gnuzilla
[[id:186a4daf-02ea-445b-9469-9909a5d7fb05][firefox]]
*** emacs-native-comp :minimal:
for development machines, gotta go fast

*** emacs :core:
*** python-3.6.4
#+begin_src scheme :tangle .config/guix/qzdl/packages/python-3.6.4.scm
(define-public python-3.6
  (package (inherit python-2)
    (version "3.6.4")
    (source (origin
              (method url-fetch)
              (uri (string-append "https://www.python.org/ftp/python/"
                                  version "/Python-" version ".tar.xz"))
              (patches (search-patches
                        "python-fix-tests.patch"
                        "python-3-fix-tests.patch"
                        "python-3-deterministic-build-info.patch"
                        "python-3-search-paths.patch"))
              (patch-flags '("-p0"))
              (sha256
               (base32
                "1fna7g8jxzl4kd2pqmmqhva5724c5m920x3fsrpsgskaylmr76qm"))
              (snippet
               '(begin
                  (for-each delete-file
                            '("Lib/ctypes/test/test_structures.py" ; fails on aarch64
                              "Lib/ctypes/test/test_win32.py" ; fails on aarch64
                              "Lib/test/test_fcntl.py")) ; fails on aarch64
                  #t))))
    ;; (arguments
    ;;  (substitute-keyword-arguments (package-arguments python-2)
    ;;    ((#:tests? _) #t)
    ;;    ((#:phases phases)
    ;;     `(modify-phases ,phases
    ;;        (add-after 'unpack 'patch-timestamp-for-pyc-files
    ;;          (lambda (_)
    ;;            ;; We set DETERMINISTIC_BUILD to only override the mtime when
    ;;            ;; building with Guix, lest we break auto-compilation in
    ;;            ;; environments.
    ;;            (setenv "DETERMINISTIC_BUILD" "1")
    ;;            (substitute* "Lib/py_compile.py"
    ;;              (("source_stats\\['mtime'\\]")
    ;;               "(1 if 'DETERMINISTIC_BUILD' in os.environ else source_stats['mtime'])"))

    ;;            ;; Use deterministic hashes for strings, bytes, and datetime
    ;;            ;; objects.
    ;;            (setenv "PYTHONHASHSEED" "0")

    ;;            ;; Reset mtime when validating bytecode header.
    ;;            (substitute* "Lib/importlib/_bootstrap_external.py"
    ;;              (("source_mtime = int\\(source_stats\\['mtime'\\]\\)")
    ;;               "source_mtime = 1"))
    ;;            #t))
    ;;        ;; These tests fail because of our change to the bytecode
    ;;        ;; validation.  They fail because expected exceptions do not get
    ;;        ;; thrown.  This seems to be no problem.
    ;;        (add-after 'unpack 'disable-broken-bytecode-tests
    ;;          (lambda
    ;;            (substitute* "Lib/test/test_importlib/source/test_file_loader.py"
    ;;              (("test_bad_marshal")
    ;;               "disable_test_bad_marshal")
    ;;              (("test_no_marshal")
    ;;               "disable_test_no_marshal")
    ;;              (("test_non_code_marshal")
    ;;               "disable_test_non_code_marshal"))
    ;;            #t))
    ;;        ;; Unset DETERMINISTIC_BUILD to allow for tests that check that
    ;;        ;; stale pyc files are rebuilt.
    ;;        (add-before 'check 'allow-non-deterministic-compilation
    ;;          (lambda _ (unsetenv "DETERMINISTIC_BUILD") #t))
    ;;        ;; We need to rebuild all pyc files for three different
    ;;        ;; optimization levels to replace all files that were not built
    ;;        ;; deterministically.

    ;;        ;; FIXME: Without this phase we have close to 2000 files that
    ;;        ;; differ across different builds of this package.  With this phase
    ;;        ;; there are about 500 files left that differ.
    ;;        (add-after 'install 'rebuild-bytecode
    ;;          (lambda* (#:key outputs #:allow-other-keys)
    ;;            (setenv "DETERMINISTIC_BUILD" "1")
    ;;            (let ((out (assoc-ref outputs "out")))
    ;;              (for-each
    ;;               (lambda (opt)
    ;;                 (format #t "Compiling with optimization level: ~a\n"
    ;;                         (if (null? opt) "none" (car opt)))
    ;;                 (for-each (lambda (file)
    ;;                             (apply invoke
    ;;                                    `(,(string-append out "/bin/python3")
    ;;                                      ,@opt
    ;;                                      "-m" "compileall"
    ;;                                      "-f" ; force rebuild
    ;;                                      ;; Don't build lib2to3, because it's Python 2 code.
    ;;                                      ;; Also don't build obviously broken test code.
    ;;                                      "-x" "(lib2to3|test/bad.*)"
    ;;                                      ,file)))
    ;;                           (find-files out "\\.py$")))
    ;;               (list '() '("-O") '("-OO"))))))))))

    ;; (native-search-paths
    ;;  (list (search-path-specification
    ;;         (variable "PYTHONPATH")
    ;;         (files (list (string-append "lib/python"
    ;;                                     (version-major+minor version)
    ;;                                     "/site-packages"))))))
))
#+end_src

#+RESULTS:
*** mvdan.cc/sh
:: [[https://guix.gnu.org/manual/en/html_node/Invoking-guix-import.html][Invoking guix import (GNU Guix Reference Manual)]]
:: [[https://github.com/mvdan/sh][GitHub: mvdan/sh]]
:: [[https://pkg.go.dev/mvdan.cc/sh/v3][sh · pkg.go.dev]]

#+begin_src scheme :tangle .config/guix/qzdl/packages/go-mvdan-sh.scm
;; <2021-08-11 Wed 13:33> `guix import go mvdan.cc/sh'
(use-modules (guix packages)
             (guix git-download)
             (guix build-system go)
             (guix licenses))



  (package
    (name "go-mvdan-cc-sh")
    (version "2.6.4+incompatible")
    (source
      (origin
        (method git-fetch)
        (uri (git-reference
               (url "https://github.com/mvdan/sh")
               (commit (go-version->git-ref version))))
        (file-name (git-file-name name version))
        (sha256
          (base32
            "1jifac0fi0sz6wzdgvk6s9xwpkdng2hj63ldbaral8n2j9km17hh"))))
    (build-system go-build-system)
    (arguments '(#:import-path "mvdan.cc/sh"))
    (home-page "https://mvdan.cc/sh")
    (synopsis "sh")
    (description
      "This package provides a shell parser, formatter and interpreter.  Supports @url{http://pubs.opengroup.org/onlinepubs/9699919799/utilities/V3_chap02.html,POSIX Shell}, @url{https://www.gnu.org/software/bash/,Bash} and
@url{https://www.mirbsd.org/mksh.htm,mksh}.  Requires Go 1.10 or later.")
    (license bsd-3))

;;go-mvdan-cc-sh
#+end_src
**

*** python-pywal :rice:
*** imagemagick

** shell
:: .config/shell

*** aliases
#+begin_src shell :tangle .config/shell/aliases
# system commands
alias \
  ls='ls -p --color=auto' \
  ll='ls -lah' \
  grep='grep --color=auto' \

alias \
  yt="youtube-dl --add-metadata -i -o '%(upload_date)s-%(title)s.%(ext)s'" \
  yta="yt -x -f bestaudio/best" \
  g='guix' \
  gp='echo $GUIX_PROFILE' \
  gg='git' \
  h='sudo herd' \
  xo='xdg-open'

# re-source
alias \
  rrb='source ~/.bashrc' \
  rrp='source $HOME/.config/shell/profile' \
  rra='source $HOME/.config/shell/aliases'

# easy check files
alias \
  aa='qz-get-aliases' \
  af='qz-get-functions'

# my functions
alias \
  gR='qz-guix-reconfigure' \
  gRd='qz-guix-reconfigure-debug' \
  gse='qz-guix-source-extra-profile'
  gsp='qz-guix-source-profile'
  dlsh='qz-download-scihub-doi'
#+end_src
*** functions
#+begin_src shell :tangle .config/shell/functions :results drawer
qz-color() {
    echo -e "$1$2${qz_reset}"
}

qz-number-lines() {
    awk '{print NR" "$0}';
}

qz-reverse() {
    qz-number-lines | sort -k1 -n -r | sed 's/^[^ ]* //g';
}

# guix reconfigure, and debug to the repl
qz-guix-reconfigure-debug()  {
    sudo -E guix repl -L "$HOME/.config/guix";
}

qz-guix-reconfigure()  {
    sudo -E guix system \
        -L "$HOME/.config/guix" \
        reconfigure "$HOME/.config/guix/qzdl/device/$(hostname).scm";
}

# guix profile commands; make it easy to switch and check
qz-guix-source-extra-profile() {
    qz-guix-source-profile "$GUIX_EXTRA_PROFILES/$@";
}
qz-guix-source-profile() {
    export GUIX_PROFILE="$@"
    . "$GUIX_PROFILE/etc/profile";
}

qz-download-scihub-doi() {
    curl -O \
        $(curl -s http://sci-hub.tw/"$@" \
          | grep location.href \
          | grep -o http.*pdf);
}

qz-get-functions() {
  FILE="$QZ_FUNCTIONS"
  cat $FILE \
    | grep -on '^qz-.*()' \
    | awk -F: '{print file":"$1,$2}' file=$FILE
}

qz-get-aliases() {
  FILE="$QZ_ALIASES"
  cat $FILE \
    | grep -on "\s.*='.*'" \
    | awk -F: '{print file":"$1,$2}' file=$FILE
}
#+end_src

#+RESULTS:
:results:
/home/samuel//.config/shell/aliasrc:3   ls='ls -p --color=auto'
/home/samuel//.config/shell/aliasrc:4   ll='ls -lah'
/home/samuel//.config/shell/aliasrc:5   grep='grep --color=auto'
/home/samuel//.config/shell/aliasrc:10   g='guix'
/home/samuel//.config/shell/aliasrc:11   gp='echo $GUIX_PROFILE'
/home/samuel//.config/shell/aliasrc:12   gg='git'
/home/samuel//.config/shell/aliasrc:13   h='sudo herd'
/home/samuel//.config/shell/aliasrc:14   xo='xdg-open'
/home/samuel//.config/shell/aliasrc:18   rrb='source ~/.bashrc'
/home/samuel//.config/shell/aliasrc:19   rrp='source ~/.profile'
/home/samuel//.config/shell/aliasrc:20   rra='source $HOME/.config/shell/aliasrc'
/home/samuel//.config/shell/aliasrc:24   aa='cat '
/home/samuel//.config/shell/aliasrc:28   gse='qz/guix-source-extra-profile'
/home/samuel//.config/shell/aliasrc:29   gsp='qz/guix-source-profile'
/home/samuel//.config/shell/aliasrc:30   dlsh='qz/download-scihub-doi'
:end:
*** variables
#+begin_src shell :tangle .config/shell/variables
export CONFIG_DIR="$HOME/.config"
export CONFIG_DIR_SHELL="$CONFIG_DIR/shell"

export QZ_ALIASES="$CONFIG_DIR_SHELL/aliases"
export QZ_FUNCTIONS="$CONFIG_DIR_SHELL/functions"
export QZ_VARIABLES="$CONFIG_DIR_SHELL/variables"

export VC_DIR="$HOME/git"
export EMACS_DIR="$HOME/.doom.d"

# recoll indexer var -> set in recoll config, and web extension too
export webdownloadsdir="$HOME/Downloads/recoll"

export EDITOR='emacsclient -c -a emacs'
export TERMINAL='emacsclient -c -e "(vterm)" -a emacs -e "(vterm)"'
export BROWSER='firefox'

# fix ~/ carnage
export XDG_CONFIG_HOME="$HOME/.config"
export XDG_DATA_DIRS="$HOME/.guix-profile/share${XDG_DATA_DIRS:+:}$XDG_DATA_DIRS"
export XDG_CACHE_HOME="$HOME/.cache"
export GIO_EXTRA_MODULES="$HOME/.guix-profile/lib/gio/modules${GIO_EXTRA_MODULES:+:}$GIO_EXTRA_MODULES"
export WGETRC="${XDG_CONFIG_HOME:-$HOME/.config}/wget/wgetrc"
export INPUTRC="${XDG_CONFIG_HOME:-$HOME/.config}/shell/inputrc"

export SUDO_ASKPASS='dmenu'

export GUIX_EXTRA_PROFILES="$HOME/.guix-extra-profiles"
export GUIX_PROFILE="$HOME/.guix-profile"

export PATH="$HOME/.local/bin/:$PATH"
export FPATH="$CONFIG_DIR_SHELL:$FPATH"

# https://techstop.github.io/bash-script-colors/
export qz_red="\e[0;91m"
export qz_blue="\e[0;94m"
export qz_expand_bg="\e[K"
export qz_blue_bg="\e[0;104m${qz/expand_bg}"
export qz_red_bg="\e[0;101m${qz/expand_bg}"
export qz_green_bg="\e[0;102m${qz/expand_bg}"
export qz_green="\e[0;92m"
export qz_greener="\033[1;32m"
export qz_white="\e[0;97m"
export qz_bold="\e[1m"
export qz_uline='\e[4m'
export qz_reset='\e[0m'
#+end_src

#+RESULTS:

*** .bashrc :file:
**** exports
export 'SHELL' to child processes

'screen' will honor it and otherwise use ~/bin/sh~
#+begin_src bash :tangle .bashrc
export SHELL
#+end_src
**** sources
references to other files
***** include env vars in ssh sessions
#+begin_src bash :tangle .bashrc
if [[ $- != *i* ]]
then
    # We are being invoked from a non-interactive shell.  If this
    # is an SSH session (as in "ssh host command"), source
    # /etc/profile so we get PATH and other essential variables.
    [[ -n "$SSH_CLIENT" ]] && source /etc/profile

    # Don't do anything else.
    return
fi
#+end_src
***** reference other files
#+begin_src bash :tangle .bashrc
# Source the system-wide file.

. /etc/bashrc
. $QZ_ALIASES
. $HOME/ns.sh # pyenv
#+end_src

**** vterm
:: [[https://github.com/akermu/emacs-libvterm#shell-side-configuration][GitHub - akermu/emacs-libvterm: Emacs libvterm integration]]
a terminal in emacs

***** filter input for vterm compatibility
#+begin_src bash :tangle .bashrc
# emacs-vterm display helper
vterm_printf(){
    if [ -n "$TMUX" ] && ([ "${TERM%%-*}" = "tmux" ] || [ "${TERM%%-*}" = "screen" ] ); then
        # Tell tmux to pass the escape sequences through
        printf "\ePtmux;\e\e]%s\007\e\\" "$1"
    elif [ "${TERM%%-*}" = "screen" ]; then
        # GNU screen (screen, screen-256color, screen-256color-bce)
        printf "\eP\e]%s\007\e\\" "$1"
    else
        printf "\e]%s\e\\" "$1"
    fi
}
#+end_src
***** clear scrollback
:: https://github.com/akermu/emacs-libvterm#vterm-clear-scrollback
#+begin_src bash :tangle .bashrc
# emacs-vterm: clear scrollback
if [[ "$INSIDE_EMACS" = 'vterm' ]]; then
    function clear(){
        vterm_printf "51;Evterm-clear-scrollback";
        tput clear;
    }
fi
#+end_src
**** colouring
:: [[https://en.wikipedia.org/wiki/ANSI_escape_code#24-bit][ANSI escape code - Wikipedia]]
# ESC[ 38;2;⟨r⟩;⟨g⟩;⟨b⟩ m Select RGB foreground color
# ESC[ 48;2;⟨r⟩;⟨g⟩;⟨b⟩ m Select RGB background color
**** TODO PS1
#+name: current PS1
#+begin_example
[18:41] [samuel : donutrust] [/home/samuel/dotfiles]↝
∴
#+end_example


#+begin_src bash :tangle .bashrc
# VTERM PS1
vterm_prompt_end(){
    vterm_printf "51;A$(whoami)@$(hostname):$(pwd)"
}
# Adjust the prompt depending on whether we're in 'guix environment'.
if [ -n "$GUIX_ENVIRONMENT" ]
then
    GUIX_ENV_PS1='[env]'
else
    GUIX_ENV_PS1=''
fi

therefore="$(echo -e '\U2234')"
arrow="$(echo -e '\U219D')"
hammer="🔨"
money="💰"
spades="🂡"
king="♚"
dice="🎲"
end=$money
break=""

    PS1="\n┏━❨\A❩━❨\u@\h❩━❨\w❩$break"
PS1="$PS1\n┗━$GUIX_ENV_PS1$end "

PS1=$PS1'\[$(vterm_prompt_end)\]'

$HOME/.local/bin/unix
#+end_src
**** TODO ascii
***** clippy
#+begin_src bash :tangle .local/bin/clippy :tangle-mode (identity #o755)
echo "
░░░░░░▄████▄
░░░░░▐▌░░░░▐▌
░░▄▀▀█▀░░░░▐▌
░░▄░▐▄░░░░░▐▌▀▀▄
▐▀░▄▄░▀▌░▄▀▀░▀▄░▀
▐░▀██▀░▌▐░▄██▄░▌
░▀▄░▄▄▀░▐░░▀▀░░▌
░░░░█░░░░▀▄▄░▄▀
░░░░█░█░░░░█░▐
░░░░█░█░░░▐▌░█
░░░░█░█░░░▐▌░█
░░░░▐▌▐▌░░░█░█
░░░░▐▌░█▄░▐▌░█
░░░░░█░░▀▀▀░░▐▌
░░░░░▐▌░░░░░░█
░░░░░░█▄░░░░▄█
░░░░░░░▀████▀"
#+end_src

#+RESULTS:
|                   |
| ░░░░░░▄████▄      |
| ░░░░░▐▌░░░░▐▌     |
| ░░▄▀▀█▀░░░░▐▌     |
| ░░▄░▐▄░░░░░▐▌▀▀▄  |
| ▐▀░▄▄░▀▌░▄▀▀░▀▄░▀ |
| ▐░▀██▀░▌▐░▄██▄░▌  |
| ░▀▄░▄▄▀░▐░░▀▀░░▌  |
| ░░░░█░░░░▀▄▄░▄▀   |
| ░░░░█░█░░░░█░▐    |
| ░░░░█░█░░░▐▌░█    |
| ░░░░█░█░░░▐▌░█    |
| ░░░░▐▌▐▌░░░█░█    |
| ░░░░▐▌░█▄░▐▌░█    |
| ░░░░░█░░▀▀▀░░▐▌   |
| ░░░░░▐▌░░░░░░█    |
| ░░░░░░█▄░░░░▄█    |
| ░░░░░░░▀████▀     |
***** unix
#+begin_src bash :tangle .local/bin/unix :tangle-mode (identity #o755)
#!/bin/sh
#original artwork by http://www.sanderfocus.nl/#/portfolio/tech-heroes
#converted to shell by #nixers @ irc.unix.chat

cat << 'eof'
                     [38;5;255m,_ ,_==▄▂[0m
                  [38;5;255m,  ▂▃▄▄▅▅[48;5;240m▅[48;5;20m▂[48;5;240m▅¾[0m.            [38;5;199m/    [38;5;20m/[0m
                   [38;5;255m[48;5;20m▄[0m[38;5;255m[48;5;199m▆[38;5;16m[48;5;255m<´  [38;5;32m"[38;5;34m»[38;5;255m▓▓[48;5;32m▓[48;5;240m%[0m\       [38;5;199m/ [38;5;20m/   [38;5;45m/ [38;5;118m/[0m
                 [38;5;255m,[38;5;255m[48;5;240m▅[38;5;16m[48;5;255m7"     [38;5;160m´[38;5;34m>[38;5;255m[48;5;39m▓▓[38;5;199m[48;5;255m▓[0m[38;5;255m%   [38;5;20m/  [38;5;118m/ [38;5;199m> [38;5;118m/ [38;5;199m>[38;5;255m/[38;5;45m%[0m
                 [38;5;255m▐[48;5;240m[38;5;255m¶[48;5;240m[38;5;255m▓[48;5;255m       [38;5;196m,[38;5;34m»[48;5;201m[38;5;255m▓▓[0m[38;5;255m¾´[0m  [38;5;199m/[38;5;255m> %[38;5;199m/[38;5;118m%[38;5;255m/[38;5;199m/ [38;5;45m/  [38;5;199m/[0m
                  [38;5;255m[48;5;240m▓[48;5;255m[38;5;16m▃[48;5;16m[38;5;255m▅▅[38;5;16m[48;5;255m▅▃,,[38;5;32m▄[38;5;16m▅[38;5;255m[48;5;16m▅▅[38;5;255m[48;5;20mÆ[0m[38;5;255m\[0m[38;5;20m/[38;5;118m/[38;5;255m /[38;5;118m/[38;5;199m/[38;5;255m>[38;5;45m// [38;5;255m/[38;5;118m>[38;5;199m/   [38;5;20m/[0m
                 [48;5;20m[38;5;255mV[48;5;255m[38;5;16m║[48;5;20m[38;5;255m«[0m[38;5;255m¼.;[48;5;240m[38;5;255m→[48;5;255m[38;5;16m ║[0m[38;5;255m<«.,[48;5;25m[38;5;255m`[48;5;240m=[0m[38;5;20m/[38;5;199m/ [38;5;255m/>[38;5;45m/[38;5;118m/[38;5;255m%/[38;5;199m% / [38;5;20m/[0m
               [38;5;20m//[48;5;255m[38;5;16m╠<´ -²,)[48;5;16m[38;5;255m(▓[48;5;255m[38;5;16m~"-[38;5;199m╝/[0m[38;5;255m¾[0m[38;5;199m/ [38;5;118m%[38;5;255m/[38;5;118m>[38;5;45m/ [38;5;118m/[38;5;199m>[0m
           [38;5;20m/ / [38;5;118m/ [48;5;20m[38;5;255m▐[48;5;240m[38;5;16m%[48;5;255m -./▄▃▄[48;5;16m[38;5;255m▅[48;5;255m[38;5;16m▐[48;5;255m[38;5;16m, [38;5;199m/[48;5;199m[38;5;255m7[0m[38;5;20m/[38;5;199m/[38;5;255m;/[38;5;199m/[38;5;118m% [38;5;20m/ /[0m
           [38;5;20m/ [38;5;199m/[38;5;255m/[38;5;45m/[38;5;118m/[38;5;255m[48;5;240m`[48;5;20m[38;5;255m▌[48;5;20m[38;5;255m▐[48;5;255m[38;5;16m %z[0m[38;5;255mWv xX[48;5;20m[38;5;255m▓[48;5;34m[38;5;255m▇[48;5;199m[38;255m▌[0m[38;5;20m/[38;5;199m/[38;5;255m&;[38;5;20m% [38;5;199m/ [38;5;20m/[0m
       [38;5;20m/ / [38;5;255m/ [38;5;118m%[38;5;199m/[38;5;255m/%/[48;5;240m[38;5;255m¾[48;5;255m[38;5;16m½´[38;5;255m[48;5;16m▌[0m[38;5;246m▃▄[38;5;255m▄▄[38;5;246m▄▃▃[0m[48;5;16m[38;5;255m▐[38;5;255m[48;5;199m¶[48;5;20m[38;5;255m\[0m[38;5;20m/[0m[48;5;255m[38;5;240m&[0m [38;5;20m/[0m
         [38;5;199m<[38;5;118m/ [38;5;45m/[38;5;255m</[38;5;118m%[38;5;255m/[38;5;45m/[38;5;255m`[48;5;16m▓[48;5;255m[38;5;16m![48;5;240m[38;5;255m%[48;5;16m[38;5;255m▓[0m[38;5;255m%[48;5;240m[38;5;255m╣[48;5;240m[38;5;255;╣[0m[38;5;255mW[0m[38;5;250mY<Y)[48;5;255m[38;5;16my&[0m[38;5;255m/`[48;5;240m\[0m
     [38;5;20m/ [38;5;199m/ [38;5;199m%[38;5;255m/%[38;5;118m/[38;5;45m/[38;5;255m<[38;5;118m/[38;5;199m%[38;5;45m/[38;5;20m/[48;5;240m[38;5;255m\[38;5;16m[48;5;255mi7; ╠N[0m[38;5;246m>[38;5;255m)VY>[48;5;240m[38;5;255m7[0m[38;5;255m;  [38;5;255m[48;5;240m\[0m[38;5;255m_[0m    [38;5;255mUNIX IS VERY SIMPLE [38;5;45mIT JUST NEEDS A[0m
  [38;5;20m/   [38;5;255m/[38;5;118m<[38;5;255m/ [38;5;45m/[38;5;255m/<[38;5;199m/[38;5;20m/[38;5;199m/[38;5;20m<[38;5;255m_/%\[38;5;255m[48;5;16m▓[48;5;255m[38;5;16m  V[0m[38;5;255m%[48;5;255m[38;5;16mW[0m[38;5;255m%£)XY[0m  [38;5;240m_/%[38;5;255m‾\_,[0m   [38;5;45mGENIUS TO UNDERSTAND ITS SIMPLICITY[38;5;255m[0m
   [38;5;199m/ [38;5;255m/ [38;5;199m/[38;5;255m/[38;5;118m%[38;5;199m/[48;5;240m[38;5;255m_,=-[48;5;20m-^[0m[38;5;255m/%/%%[48;5;255m[38;5;16m\¾%[0m[38;5;255m¶[0m[48;5;255m[38;5;16m%[0m[38;5;255m%}[0m    [38;5;240m/%%%[38;5;20m%%[38;5;240m%;\,[0m
    [38;5;45m%[38;5;20m/[38;5;199m< [38;5;20m/[48;5;20m[38;5;255m_/[48;5;240m [0m[38;5;255m%%%[38;5;240m%%[38;5;20m;[38;5;255mX[38;5;240m%[38;5;20m%[38;5;255m\%[38;5;240m%;,     _/%%%;[38;5;20m,[38;5;240m     \[0m
   [38;5;118m/ [38;5;20m/ [38;5;240m%[38;5;20m%%%%[38;5;240m%;,    [38;5;255m\[38;5;240m%[38;5;20m%[38;5;255ml[38;5;240m%%;// _/[38;5;20m%;,[0m [38;5;234mdmr[0m
 [38;5;20m/    [38;5;240m%[38;5;20m%%;,[0m         [38;5;255m<[38;5;20m;[38;5;240m\-=-/ /[0m
     [38;5;20m;,[0m                [38;5;240ml[0m
eof
#+end_src

*** .profile
#+begin_src shell :tangle .config/shell/profile
source $HOME/.config/shell/variables

if [ -f ~/.bashrc ]; then . ~/.bashrc; fi

for f in functions aliases variables ; do
    . "$CONFIG_DIR_SHELL/$f";
done;

. $GUIX_PROFILE/etc/profile

export $(cat $HOME/.config/shell/variables | grep -v "^#" | cut -d= -f1)
export $(cat $HOME/.config/shell/aliases | grep  -v "#" | grep -v 'alias' | cut -d'=' -f1)
export -f $(cat $HOME/.config/shell/functions | grep  -i "^[a-z]\(\)" | cut -d'(' -f1)
export alias rrp="source $HOME/.profile"
#+end_src

**** symlink profiles :deploy:
#+begin_src shell :tangle .local/bin/deploy-dotfiles.sh
for f in .profile .bash_profile .zsh_profile; do
    ln -s $HOME/dotfiles/.config/shell/profile $HOME/$f
done;
#+end_src

#+RESULTS:

*** testing :test:
#+begin_src shell :tangle .local/bin/test-system.sh
headline "TESTING SHELL CONFIGS"
delim

block "BEGIN: linting"
echo "...TODO lint shell files @shfmt"
block "END: linting"
delim

block "BEGIN: sourcing"
tmpbase="$HOME/.config/shell"
for f in $(find "$tmpbase/") ; do
    [ -d $f ] && continue;
    echo "...sourcing $f"

    if $(source "$f"); then
        qz-color $qz_greener ".....PASSED: $f"
    else qz-color $qz_red ".....FAILED: $f"
    fi;
done;

block "END: sourcing"
#+end_src

#+RESULTS:
***

** channels
:: [[https://guix.gnu.org/en/manual/en/html_node/Channels.html#Channels][Channels (GNU Guix Reference Manual)]]
- [[https://gitlab.com/nonguix/nonguix][Nonguix / nonguix · GitLab]]; nonfree linux-kernel for wifi drivers

*** .config/guix/channels.scm :file:
#+begin_src scheme :tangle .config/guix/channels.scm
;; GENERATED BY ~/dotfiles/system.org
(list
 (channel
  (name 'guix)
  (url "https://git.savannah.gnu.org/git/guix.git"))
 ;; for the kernel + firmware
 (channel
  (name 'nonguix)
  (url "https://gitlab.com/nonguix/nonguix"))
 ;; for emacs-libgccjit
 (channel
  (name 'flat)
  (url "https://github.com/flatwhatson/guix-channel.git")
  (commit
   "86fb7253a4384b70c77739a0e03115be75d60ad1")
  (introduction
   (make-channel-introduction
    "33f86a4b48205c0dc19d7c036c85393f0766f806"
    (openpgp-fingerprint
     "736A C00E 1254 378B A982  7AF6 9DBE 8265 81B6 4490"))))
 ;; a great effort from infra hpc
 ;;(channel
 ;; (name 'guix-past)

 ;; (url "https://gitlab.inria.fr/guix-hpc/guix-past")
 ;; (introduction
 ;;  (make-channel-introduction
 ;;   "0c119db2ea86a389769f4d2b9c6f5c41c027e336"
 ;;   (openpgp-fingerprint
 ;;    "3CE4 6455 8A84 FDC6 9DB4  0CFB 090B 1199 3D9A EBB5"))))
)
  #+end_src

  #+RESULTS:
** HACK inferiors for python
this does not work how I want; it will not install python from the revision of
guix specified by the given commit sha
#+begin_src scheme :tangle no
(use-modules (guix inferior)
             (guix)
             (srfi srfi-1))

(define pychannel
  (list (channel
         (name 'guix)
         (url "https://git.savannah.gnu.org/git/guix.git")
         (commit "5c798ca71dcd009896654da7d6a1f8942c6f3c50"))))

(define inferior
  (inferior-for-channels pychannel))

(packages->manifest
 (list (first (lookup-inferior-packages inferior "python"))))
#+end_src

#+RESULTS:

** TODO emacs config as-a-package
basically, to be able to update my emacs config with ~guix pull~
*** python runtime in docker
#+begin_src bash :tangle .emacs.d/docker-pyshell.sh
docker run -it -v /tmp:/tmp -v $HOME/git ufoym/deepo python3
#+end_src

* Footnotes
[fn:5] [[https://www.gnu.org/software/guile/manual/html_node/Using-Guile-Interactively.html#Using-Guile-Interactively][Using Guile Interactively (Guile Reference Manual)]]
[fn:4] [[https://wiki.archlinux.org/title/microcode][Microcode - ArchWiki]]

[fn:3] [[https://www.kernel.org/doc/html/latest/admin-guide/initrd.html][Using the initial RAM disk (initrd) — The Linux Kernel documentation]]
[fn:2] [[https://www.tecmint.com/set-system-locales-in-linux/][How to Change or Set System Locales in Linux]]
- get: ~localectl~
- set: ~sudo localectl set-blocale LANG=en_US.UTF_8~
[fn:1] check the existing timezone with the following ([[https://www.tecmint.com/check-linux-timezone/][How to Check Timezone in Linux]])
  #+begin_src bash
  timedatectl | grep -i "time zone"
  #+end_src
